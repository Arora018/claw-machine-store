<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claw Machine Store - Offline POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #1976d2;
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-tab {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.3);
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online {
            background: #4caf50;
            color: white;
        }

        .status-offline {
            background: #ff9800;
            color: white;
        }

        .status-syncing {
            background: #2196f3;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pending-sales {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .logout-btn {
            background: #dc004e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .main-content {
            display: flex;
            flex: 1;
            height: calc(100vh - 80px);
        }

        .products-section {
            flex: 2;
            padding: 20px;
            background: white;
            overflow-y: auto;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .product-card.coins {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #8b4513;
        }

        .product-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .product-card.coins .product-name {
            color: #8b4513;
        }

        .product-price {
            font-size: 18px;
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .product-card.coins .product-price {
            color: #8b4513;
        }

        .product-category {
            font-size: 12px;
            color: #666;
            text-transform: capitalize;
        }

        .cart-section {
            flex: 1;
            background: #fafafa;
            border-left: 2px solid #e0e0e0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .cart-table {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cart-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-header {
            font-weight: bold;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            background: #1976d2;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: #1565c0;
        }

        .qty-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .qty-number {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }

        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-total {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 16px;
            text-align: center;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .payment-method {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: #1976d2;
        }

        .payment-method.selected {
            border-color: #1976d2;
            background: #1976d2;
            color: white;
        }

        .payment-method.cash.selected {
            background: #4caf50;
            border-color: #4caf50;
        }

        .payment-method.upi.selected {
            background: #ff9800;
            border-color: #ff9800;
        }

        .payment-method.card.selected {
            background: #9c27b0;
            border-color: #9c27b0;
        }

        .payment-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        .payment-info.selected {
            background: #e3f2fd;
            color: #1976d2;
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkout-btn:hover {
            background: #1565c0;
        }

        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .offline-notice {
            background: #ff9800;
            color: white;
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .sync-status {
            background: #2196f3;
            color: white;
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        /* Login screen styles */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 28px;
            color: #1976d2;
            margin-bottom: 32px;
            line-height: 1.2;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: bold;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #1976d2;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .login-btn:hover {
            background: #1565c0;
        }

        .login-hint {
            color: #666;
            font-size: 14px;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        /* Machine inventory styles */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .machine-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .machine-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }

        .machine-detail {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .status-active { color: #4caf50; }
        .status-maintenance { color: #ff9800; }
        .status-out_of_order { color: #f44336; }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // Offline-First Tablet POS Application
        class OfflineTabletPOS {
            constructor() {
                this.user = null;
                this.products = [];
                this.cart = [];
                this.machines = [];
                this.currentView = 'pos';
                this.selectedPaymentMethod = 'cash';
                this.apiBase = 'http://localhost:3000/api';
                this.isOnline = navigator.onLine;
                this.syncInProgress = false;
                this.lastSyncTime = null;
                
                this.init();
                this.setupConnectivityMonitoring();
            }

            async init() {
                // Try to restore login session
                const savedToken = localStorage.getItem('pos_token');
                if (savedToken && !this.user) {
                    try {
                        const response = await fetch(`${this.apiBase}/auth/me`, {
                            headers: { 'Authorization': `Bearer ${savedToken}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.user = { ...data.user, token: savedToken };
                        } else {
                            localStorage.removeItem('pos_token');
                        }
                    } catch (error) {
                        localStorage.removeItem('pos_token');
                    }
                }
                
                await this.fetchProducts();
                await this.fetchMachines();
                this.render();

                // Auto-sync when online
                if (this.isOnline) {
                    this.syncPendingSales();
                }
            }

            setupConnectivityMonitoring() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.render();
                    this.syncPendingSales();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.render();
                });

                // Check connectivity periodically
                setInterval(() => {
                    this.checkConnectivity();
                }, 30000); // Check every 30 seconds
            }

            async checkConnectivity() {
                try {
                    const response = await fetch(`${this.apiBase}/sync/status`, {
                        headers: this.getAuthHeaders(),
                        signal: AbortSignal.timeout(5000) // 5 second timeout
                    });
                    const wasOnline = this.isOnline;
                    this.isOnline = response.ok;
                    
                    if (!wasOnline && this.isOnline) {
                        // Just came back online
                        this.render();
                        this.syncPendingSales();
                    } else if (wasOnline && !this.isOnline) {
                        // Just went offline
                        this.render();
                    }
                } catch (error) {
                    this.isOnline = false;
                    this.render();
                }
            }

            // Local Storage Management
            getPendingSales() {
                const pending = localStorage.getItem('pending_sales');
                return pending ? JSON.parse(pending) : [];
            }

            savePendingSale(sale) {
                const pending = this.getPendingSales();
                pending.push(sale);
                localStorage.setItem('pending_sales', JSON.stringify(pending));
            }

            clearPendingSales() {
                localStorage.removeItem('pending_sales');
            }

            // Sync functionality
            async syncPendingSales() {
                if (!this.isOnline || this.syncInProgress) return;

                const pendingSales = this.getPendingSales();
                if (pendingSales.length === 0) return;

                this.syncInProgress = true;
                this.render();

                try {
                    const response = await fetch(`${this.apiBase}/sync/sales/bulk`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...this.getAuthHeaders()
                        },
                        body: JSON.stringify({ sales: pendingSales })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.clearPendingSales();
                        this.lastSyncTime = new Date().toISOString();
                        console.log(`Sync completed: ${result.newSales} new sales uploaded`);
                    }
                } catch (error) {
                    console.error('Sync failed:', error);
                } finally {
                    this.syncInProgress = false;
                    this.render();
                }
            }

            async fetchProducts() {
                const demoProducts = [
                    { _id: '1', name: '1 Coin', price: 100, category: 'coins' },
                    { _id: '2', name: '7 Coins', price: 500, category: 'coins' },
                    { _id: '3', name: '15 Coins', price: 1000, category: 'coins' },
                    { _id: '4', name: 'Teddy Bear', price: 250, category: 'plush_toy' },
                    { _id: '5', name: 'Pokemon Figure', price: 400, category: 'figurine' },
                    { _id: '6', name: 'Hello Kitty Plush', price: 350, category: 'plush_toy' },
                    { _id: '7', name: 'Gummy Bears', price: 80, category: 'candy' }
                ];

                try {
                    if (this.isOnline) {
                        const response = await fetch(`${this.apiBase}/products`, {
                            headers: this.getAuthHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.products = (data.products && data.products.length > 0) ? data.products : demoProducts;
                            // Cache products for offline use
                            localStorage.setItem('cached_products', JSON.stringify(this.products));
                            return;
                        }
                    }
                    
                    // Use cached products if available
                    const cached = localStorage.getItem('cached_products');
                    this.products = cached ? JSON.parse(cached) : demoProducts;
                } catch (error) {
                    const cached = localStorage.getItem('cached_products');
                    this.products = cached ? JSON.parse(cached) : demoProducts;
                }
            }

            async fetchMachines() {
                const demoMachines = [
                    { _id: '1', machineId: 'CM001', name: 'Main Claw Machine', location: 'Entrance', status: 'active', coinCount: 45, currentToyCount: 12, maxCapacity: 20 },
                    { _id: '2', machineId: 'CM002', name: 'Mini Claw Machine', location: 'Corner', status: 'active', coinCount: 23, currentToyCount: 8, maxCapacity: 15 }
                ];

                try {
                    if (this.isOnline) {
                        const response = await fetch(`${this.apiBase}/machines`, {
                            headers: this.getAuthHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.machines = data || demoMachines;
                            localStorage.setItem('cached_machines', JSON.stringify(this.machines));
                            return;
                        }
                    }
                    
                    const cached = localStorage.getItem('cached_machines');
                    this.machines = cached ? JSON.parse(cached) : demoMachines;
                } catch (error) {
                    const cached = localStorage.getItem('cached_machines');
                    this.machines = cached ? JSON.parse(cached) : demoMachines;
                }
            }

            getAuthHeaders() {
                const token = this.user?.token || localStorage.getItem('pos_token');
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            }

            async login(username, password) {
                try {
                    const response = await fetch(`${this.apiBase}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.user = { ...data.user, token: data.token };
                        localStorage.setItem('pos_token', data.token);
                        await this.fetchProducts();
                        await this.fetchMachines();
                        this.render();
                        return { success: true };
                    } else {
                        return { success: false, message: 'Invalid credentials' };
                    }
                } catch (error) {
                    // Demo mode for offline testing
                    if (username === 'admin' && password === 'admin123') {
                        this.user = { username: 'admin', role: 'admin' };
                        this.render();
                        return { success: true };
                    }
                    return { success: false, message: 'Connection failed - try demo mode' };
                }
            }

            logout() {
                this.user = null;
                this.cart = [];
                this.selectedPaymentMethod = 'cash';
                localStorage.removeItem('pos_token');
                this.render();
            }

            addToCart(product) {
                const existingItem = this.cart.find(item => item.product._id === product._id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    this.cart.push({ product, quantity: 1 });
                }
                this.render();
            }

            removeFromCart(productId) {
                this.cart = this.cart.filter(item => item.product._id !== productId);
                this.render();
            }

            adjustQuantity(productId, change) {
                const item = this.cart.find(item => item.product._id === productId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        this.removeFromCart(productId);
                    } else {
                        this.render();
                    }
                }
            }

            getTotal() {
                return this.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            }

            selectPaymentMethod(method) {
                this.selectedPaymentMethod = method;
                this.render();
            }

            getPaymentMethodLabel() {
                const methods = {
                    'cash': 'Cash',
                    'upi': 'UPI',
                    'card': 'Card'
                };
                return methods[this.selectedPaymentMethod] || 'Cash';
            }

            generateClientId() {
                return 'sale_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            async processSale() {
                if (this.cart.length === 0) {
                    alert('Cart is empty!');
                    return;
                }

                const total = this.getTotal();
                const paymentMethod = this.getPaymentMethodLabel();
                const confirmed = confirm(`Process sale for â‚¹${total} via ${paymentMethod}?`);
                
                if (!confirmed) return;

                const sale = {
                    clientId: this.generateClientId(),
                    items: this.cart.map(item => ({
                        product: item.product._id,
                        quantity: item.quantity
                    })),
                    paymentMethod: this.selectedPaymentMethod,
                    total: total,
                    timestamp: new Date().toISOString(),
                    cashier: this.user?.username || 'admin'
                };

                if (this.isOnline) {
                    // Try to save to server immediately
                    try {
                        const response = await fetch(`${this.apiBase}/sales`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...this.getAuthHeaders()
                            },
                            body: JSON.stringify(sale)
                        });

                        if (response.ok) {
                            alert(`Sale completed successfully via ${paymentMethod}! âœ… Saved to database.`);
                        } else {
                            throw new Error('Server error');
                        }
                    } catch (error) {
                        // Save locally if server fails
                        this.savePendingSale(sale);
                        alert(`Sale completed via ${paymentMethod}! ðŸ“± Saved locally (will sync when connected).`);
                    }
                } else {
                    // Save locally when offline
                    this.savePendingSale(sale);
                    alert(`Sale completed via ${paymentMethod}! ðŸ“± Saved locally (will sync when connected).`);
                }

                this.cart = [];
                this.selectedPaymentMethod = 'cash';
                this.render();
            }

            getConnectionStatus() {
                if (this.syncInProgress) {
                    return { text: 'Syncing...', class: 'status-syncing' };
                } else if (this.isOnline) {
                    return { text: 'Online', class: 'status-online' };
                } else {
                    return { text: 'Offline', class: 'status-offline' };
                }
            }

            render() {
                const app = document.getElementById('app');

                if (!this.user) {
                    app.innerHTML = this.renderLogin();
                    return;
                }

                if (this.currentView === 'inventory') {
                    app.innerHTML = this.renderInventory();
                } else {
                    app.innerHTML = this.renderPOS();
                }
            }

            renderLogin() {
                return `
                    <div class="login-screen">
                        <div class="login-form">
                            <h1 class="login-title">Claw Machine Store<br>Offline POS</h1>
                            <div id="loginError"></div>
                            <div class="input-group">
                                <label class="input-label">Username</label>
                                <input type="text" id="username" class="input-field" value="admin">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Password</label>
                                <input type="password" id="password" class="input-field" value="admin123">
                            </div>
                            <button class="login-btn" onclick="app.handleLogin()">Login</button>
                            <p class="login-hint">Default: admin / admin123 (works offline)</p>
                        </div>
                    </div>
                `;
            }

            renderPOS() {
                const status = this.getConnectionStatus();
                const pendingSales = this.getPendingSales();
                
                return `
                    <div class="header">
                        <div class="title">Claw Machine Store - POS</div>
                        <div class="user-info">
                            <span class="status-indicator ${status.class}">${status.text}</span>
                            ${pendingSales.length > 0 ? `<span class="pending-sales">${pendingSales.length} pending</span>` : ''}
                            <span>Welcome, ${this.user.username}</span>
                            <button class="nav-tab ${this.currentView === 'pos' ? 'active' : ''}" onclick="app.setView('pos')">POS</button>
                            <button class="nav-tab ${this.currentView === 'inventory' ? 'active' : ''}" onclick="app.setView('inventory')">Inventory</button>
                            <button class="logout-btn" onclick="app.logout()">Logout</button>
                        </div>
                    </div>
                    <div class="main-content">
                        <div class="products-section">
                            <h2 class="section-title">Products</h2>
                            ${!this.isOnline ? '<div class="offline-notice">ðŸ“± Working offline - sales will sync when connected</div>' : ''}
                            ${this.syncInProgress ? '<div class="sync-status">ðŸ”„ Syncing pending sales...</div>' : ''}
                            <div class="products-grid">
                                ${this.products.map(product => `
                                    <div class="product-card ${product.category}" onclick="app.addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                        <div class="product-name">${product.name}</div>
                                        <div class="product-price">â‚¹${product.price}</div>
                                        <div class="product-category">${product.category.replace('_', ' ')}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="cart-section">
                            <h2 class="section-title">Shopping Cart</h2>
                            <div class="cart-table">
                                <div class="cart-item cart-header">
                                    <div>Product</div>
                                    <div>Qty</div>
                                    <div>Price</div>
                                    <div>Total</div>
                                    <div>Action</div>
                                </div>
                                ${this.cart.map(item => `
                                    <div class="cart-item">
                                        <div>${item.product.name}</div>
                                        <div class="quantity-controls">
                                            <button class="qty-btn" onclick="app.adjustQuantity('${item.product._id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                                            <span class="qty-number">${item.quantity}</span>
                                            <button class="qty-btn" onclick="app.adjustQuantity('${item.product._id}', 1)">+</button>
                                        </div>
                                        <div>â‚¹${item.product.price}</div>
                                        <div>â‚¹${(item.product.price * item.quantity)}</div>
                                        <div><button class="remove-btn" onclick="app.removeFromCart('${item.product._id}')">Remove All</button></div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="cart-total">
                                <div class="total-amount">Total: â‚¹${this.getTotal()}</div>
                                
                                <div class="payment-methods">
                                    <button class="payment-method cash ${this.selectedPaymentMethod === 'cash' ? 'selected' : ''}" onclick="app.selectPaymentMethod('cash')">
                                        ðŸ’µ Cash
                                    </button>
                                    <button class="payment-method upi ${this.selectedPaymentMethod === 'upi' ? 'selected' : ''}" onclick="app.selectPaymentMethod('upi')">
                                        ðŸ“± UPI
                                    </button>
                                    <button class="payment-method card ${this.selectedPaymentMethod === 'card' ? 'selected' : ''}" onclick="app.selectPaymentMethod('card')">
                                        ðŸ’³ Card
                                    </button>
                                </div>
                                
                                <div class="payment-info ${this.selectedPaymentMethod ? 'selected' : ''}">
                                    Selected: ${this.getPaymentMethodLabel()}
                                </div>
                                
                                <button class="checkout-btn" onclick="app.processSale()" ${this.cart.length === 0 ? 'disabled' : ''}>
                                    Process Sale (${this.getPaymentMethodLabel()})
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderInventory() {
                const status = this.getConnectionStatus();
                const pendingSales = this.getPendingSales();
                
                return `
                    <div class="header">
                        <div class="title">Inventory & Machine Management</div>
                        <div class="user-info">
                            <span class="status-indicator ${status.class}">${status.text}</span>
                            ${pendingSales.length > 0 ? `<span class="pending-sales">${pendingSales.length} pending</span>` : ''}
                            <span>Welcome, ${this.user.username}</span>
                            <button class="nav-tab ${this.currentView === 'pos' ? 'active' : ''}" onclick="app.setView('pos')">POS</button>
                            <button class="nav-tab ${this.currentView === 'inventory' ? 'active' : ''}" onclick="app.setView('inventory')">Inventory</button>
                            <button class="logout-btn" onclick="app.logout()">Logout</button>
                        </div>
                    </div>
                    <div class="main-content">
                        <div class="products-section" style="flex: 1;">
                            ${!this.isOnline ? '<div class="offline-notice">ðŸ“± Working offline - data from cache</div>' : ''}
                            
                            <h2 class="section-title">Machine Status</h2>
                            <div class="inventory-grid">
                                ${this.machines.map(machine => `
                                    <div class="machine-card">
                                        <div class="machine-name">${machine.name} (${machine.machineId})</div>
                                        <div class="machine-detail">
                                            <span>Location:</span>
                                            <span>${machine.location}</span>
                                        </div>
                                        <div class="machine-detail">
                                            <span>Status:</span>
                                            <span class="status-${machine.status}">${machine.status.replace('_', ' ')}</span>
                                        </div>
                                        <div class="machine-detail">
                                            <span>Coins:</span>
                                            <span>${machine.coinCount}</span>
                                        </div>
                                        <div class="machine-detail">
                                            <span>Toys:</span>
                                            <span>${machine.currentToyCount}/${machine.maxCapacity}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <h2 class="section-title" style="margin-top: 32px;">Products Inventory</h2>
                            <div class="inventory-grid">
                                ${this.products.map(product => `
                                    <div class="machine-card">
                                        <div class="machine-name">${product.name}</div>
                                        <div class="machine-detail">
                                            <span>Price:</span>
                                            <span>â‚¹${product.price}</span>
                                        </div>
                                        <div class="machine-detail">
                                            <span>Category:</span>
                                            <span>${product.category.replace('_', ' ')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            ${pendingSales.length > 0 ? `
                                <h2 class="section-title" style="margin-top: 32px;">Pending Sales (${pendingSales.length})</h2>
                                <div class="inventory-grid">
                                    ${pendingSales.slice(0, 5).map(sale => `
                                        <div class="machine-card">
                                            <div class="machine-name">Sale â‚¹${sale.total}</div>
                                            <div class="machine-detail">
                                                <span>Payment:</span>
                                                <span>${sale.paymentMethod.toUpperCase()}</span>
                                            </div>
                                            <div class="machine-detail">
                                                <span>Items:</span>
                                                <span>${sale.items.length} items</span>
                                            </div>
                                            <div class="machine-detail">
                                                <span>Time:</span>
                                                <span>${new Date(sale.timestamp).toLocaleTimeString()}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${pendingSales.length > 5 ? `
                                        <div class="machine-card">
                                            <div class="machine-name">+ ${pendingSales.length - 5} more</div>
                                            <div class="machine-detail">
                                                <span>Status:</span>
                                                <span>Will sync when online</span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            async handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');

                const result = await this.login(username, password);
                if (!result.success) {
                    errorDiv.innerHTML = `<div class="error-message">${result.message}</div>`;
                } else {
                    errorDiv.innerHTML = `<div class="success-message">Login successful!</div>`;
                }
            }

            setView(view) {
                this.currentView = view;
                this.render();
            }
        }

        // Initialize the application
        const app = new OfflineTabletPOS();
        window.app = app; // Make it globally accessible for onclick handlers
    </script>
</body>
</html>
